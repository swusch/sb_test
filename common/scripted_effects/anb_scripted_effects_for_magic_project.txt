give_magical_infrastructure_temp_bypass = {
	custom_tooltip = give_magical_infrastructure_temp_bypass
	set_country_flag = MI_temporary_bypass_flag
}
give_magical_infrastructure_perm_bypass = {
	custom_tooltip = give_magical_infrastructure_perm_bypass
	set_country_flag = MI_permanent_bypass_flag
}
give_magical_infrastructure_ruler_bypass = {
	custom_tooltip = give_magical_infrastructure_ruler_bypass
	set_ruler_flag = MI_permanent_bypass_flag
}

magical_fortress_suffer_setback = {
	increase_magic_experience = { unmodified_amount = $amount$ }
	custom_tooltip = tooltip_gain_on_complete_project
	[[mod]
		tooltip = { add_ruler_modifier = { name = magical_fortress_$mod$_mod duration = 18250 } }
		set_country_flag = magic_project_picked_setback_option
	]
	[[effect] tooltip = { $effect$ } ]
}

magical_fortress_grant_bonus = {
	if = {
		limit = { has_country_flag = magic_project_picked_setback_option }
		add_ruler_modifier = { name = magical_fortress_$mod$_mod duration = 18250 }
		clr_country_flag = magic_project_picked_setback_option
	}
}

summon_extraplanars_school_check = {
	increase_magic_experience = { amount = $xp$ }
	custom_tooltip = magic_effect_separator_tt
	custom_tooltip = is_overall_$school$_level_1_minimum
	if = {
		limit = { is_overall_$school$_level_1_minimum = yes }
		custom_tooltip = BONUS_REWARD_YES
		change_variable = { summon_extraplanars_astral_gloam = 1 }
		custom_tooltip = mission_alternatively_tt
		custom_tooltip = BONUS_REWARD_NO
		tooltip = { change_variable = { summon_extraplanars_astral_gloam = 2 } }
	}
	else = {
		custom_tooltip = BONUS_REWARD_NO
		tooltip = { change_variable = { summon_extraplanars_astral_gloam = 1 } }
		custom_tooltip = mission_alternatively_tt
		custom_tooltip = BONUS_REWARD_YES
		change_variable = { summon_extraplanars_astral_gloam = 2 }
	}
}

summon_extraplanars_summon_rebels = {
	custom_tooltip = summon_extraplanars_astral_gloam_consequences
	if = {
		limit = { check_variable = { summon_extraplanars_astral_gloam = 6 } }
		capital_scope = { magical_abomination = 2.5 }
	}
	if = {
		limit = { check_variable = { summon_extraplanars_astral_gloam = 4 } }
		capital_scope = { magical_abomination = 1.5 }
	}
	if = {
		limit = { check_variable = { summon_extraplanars_astral_gloam = 2 } }
		capital_scope = { magical_abomination = 0.8 }
	}
	custom_tooltip = " "
}

artifact_of_enthrallment_story_unravels = {
	custom_tooltip = artifact_of_enthrallment_story_unravels
	if = {
		limit = { has_country_modifier = studying_artifact_of_enthrallment_mod_1 }
		remove_country_modifier = studying_artifact_of_enthrallment_mod_1
		add_country_modifier = { name = studying_artifact_of_enthrallment_mod_2 duration = -1 desc = until_advancement_concludes }
	}
	else = { remove_country_modifier = studying_artifact_of_enthrallment_mod_2 }
}

artifact_of_enthrallment_clr_id_flags = {
	if = {
		limit = { NOT = { exactly_magic_project_level = { project = artifact_of_enthrallment level = 2 } } }
		clr_country_flag = artifact_of_enthrallment_chose_$id1$
		clr_country_flag = artifact_of_enthrallment_chose_$id2$
	}
}

artifact_of_enthrallment_tell_the_story = {
	if = {
		limit = { exactly_magic_project_level = { project = artifact_of_enthrallment level = 2 } }
		custom_tooltip = artifact_of_enthrallment_tell_the_story
		hidden_effect = {
			[[next]
				if = {
					limit = { has_country_flag = artifact_of_enthrallment_chose_$id$ }
					country_event = { id = magic_project_artifact_of_enthrallment.$next$ }
				}
			]
			if = {
				limit = { NOT = { has_country_flag = artifact_of_enthrallment_chose_$id$ } }
				country_event = { id = magic_project_artifact_of_enthrallment.10 }
			}
		}
	}
	else = {
		[[else] $else$ ]
		set_country_flag = artifact_of_enthrallment_chose_$id$
	}
}

theatre_of_simulacra_lose_sanity = {
	custom_tooltip = theatre_lie_tooltip
	if = {
		limit = { has_country_modifier = theatre_lie_8 }
		remove_country_modifier = theatre_lie_8
		add_ruler_modifier = { name = theatre_lie_9 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_7 }
		remove_country_modifier = theatre_lie_7
		add_ruler_modifier = { name = theatre_lie_8 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_6 }
		remove_country_modifier = theatre_lie_6
		add_ruler_modifier = { name = theatre_lie_7 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_5 }
		remove_country_modifier = theatre_lie_5
		add_ruler_modifier = { name = theatre_lie_6 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_4 }
		remove_country_modifier = theatre_lie_4
		add_ruler_modifier = { name = theatre_lie_5 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_3 }
		remove_country_modifier = theatre_lie_3
		add_ruler_modifier = { name = theatre_lie_4 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_2 }
		remove_country_modifier = theatre_lie_2
		add_ruler_modifier = { name = theatre_lie_3 duration = -1 }
	}
	else_if = {
		limit = { has_country_modifier = theatre_lie_1 }
		remove_country_modifier = theatre_lie_1
		add_ruler_modifier = { name = theatre_lie_2 duration = -1 }
	}
	else = { add_ruler_modifier = { name = theatre_lie_1 duration = -1 } }

	if = {
		limit = { exactly_magic_project_level = { project = theatre_of_simulacra level = 2 } }
		increase_magic_experience = { amount = 60 }
	}
	if = {
		limit = { exactly_magic_project_level = { project = theatre_of_simulacra level = 1 } }
		increase_magic_experience = { amount = 40 }
	}
	if = {
		limit = { exactly_magic_project_level = { project = theatre_of_simulacra level = 0 } }
		increase_magic_experience = { amount = 20 }
	}
}

theatre_of_simulacra_add_bonus = {
	if = {
		limit = {
			check_variable = {
				which = theatre_of_simulacra_bonuses
				which = theatre_of_simulacra_level
			}
		}
		custom_tooltip = no_theatre_of_simulacra_has_space_tt
	}
	else = {
		custom_tooltip = yes_theatre_of_simulacra_has_space_tt
		change_variable = { which = theatre_of_simulacra_bonuses value = 1 }
		add_country_modifier = { name = theatre_$bonus$_bonus duration = -1 hidden = yes } #View via the decision, prevent modifier spam
		set_country_flag = new_theatre_bonus
	}
	tooltip = { add_country_modifier = { name = theatre_$bonus$_bonus duration = -1 } }
}

theatre_of_simulacra_remove_bonus = {
	subtract_variable = { which = theatre_of_simulacra_bonuses value = 1 }
	remove_country_modifier = theatre_$bonus$_bonus
}

become_a_lich_effect = {
	if = {
		limit = { ruler_is_not_lich = yes }
		#become_a_witch_king_effect = yes #not all liches are witch-kings, call this separately.
			
		custom_tooltip = become_a_lich_tt

		set_ruler_flag = long_lived_ruler	### This puts you on the same level as elves, dwarves, etc.
		set_country_flag = ruled_by_lich	### This DEFINES a lich nation, and keeps you immortal.

		### This is just for modifiers and cool text. You lose it briefly during revival.
		if = {
			limit = { has_country_flag = b38_entef_ruler }
			add_ruler_modifier = { name = entef_ruler duration = -1 }
		}
		add_ruler_modifier = { name = lich_ruler duration = -1 }
		
		### For when you die and need to revive
		save_persistent_ruler_personalities = yes
		save_ruler_stats = yes
		save_spell_levels_for_type_to_name = { type = ruler name = immortal }
		save_ruler_dynasty = yes

		if = { ### You only need the female flag
			limit = { is_female = yes }
			set_country_flag = lich_ruler_female
		}
			
		#Consequences of being a Lich: you are a Magocracy
		artifice_magic_switch_to_magic_only_mode = yes
		hidden_effect = {
			country_event = { id = magic_project_lichdom.12 days = 1 }
			set_variable = { lichdom_project = 3 } #You completed a project! congrats
			calc_completed_magic_projects = yes
		}


		if = { #MT Stuff
			limit = { tag = B39 has_ruler_flag = wyvernheart_the_regent }
			set_country_flag = wyvernheart_the_regent_lich
		}
	}
}
kill_a_lich_effect = {
	if = {
		limit = { ruler_is_lich = yes }
		clr_ruler_flag = long_lived_ruler
		clr_country_flag = ruled_by_lich
		remove_country_modifier = entef_ruler
		remove_country_modifier = lich_ruler
		clr_country_flag = lich_ruler_female
		clear_saved_spell_levels_for_name = { name = immortal }
		clear_saved_persistent_ruler_personalities = yes

		add_ruler_modifier = { name = lich_no_phylactery duration = -1 }
		change_adm = -6
		change_dip = -6
		change_mil = -6

		hidden_effect = { 
			country_event = { id = magic_project_lichdom.13 days = 1 } 
			if = {
				limit = {
					OR = {
						artificery_locked_mixed_mode = yes
						artificery_locked_artificery_mode = yes
						artificery_tag_needs_artificers = yes
					}
					has_country_flag = artificery_unlocked
				}
				country_event = { id = magic_artificery_setup.1 days = 7 }
			}
		}
	}
}
magic_project_clear_lichdom_government_flags = {
	clr_country_flag = wizard_king_magocracy
	clr_country_flag = original_gov_monarchy
	clr_country_flag = original_gov_republic
	clr_country_flag = original_gov_theocracy
	clr_country_flag = original_gov_clergy
	clr_country_flag = original_gov_monastic
	clr_country_flag = original_gov_secular
	clr_country_flag = original_gov_adventurer
	clr_country_flag = original_gov_oracular
	clr_country_flag = original_gov_tribal
}